---
- name: Uninstall Korifi
  shell: |
    helm uninstall korifi -n korifi
  register: uninstall_korifi
  ignore_errors: true
  args:
    chdir: "{{ base_path }}/"
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.PATH }}"
- debug: msg={{ uninstall_korifi }}
  when: print_debug == true


# --version should be helm chart version, not app version
#- name: Uninstall Reflector
#  shell: |
#    /usr/local/bin/helm uninstall reflector -n reflector
#  register: uninstall_reflector
#  ignore_errors: true
#  args:
#    chdir: "{{ base_path }}/"
#- debug: msg={{ uninstall_reflector }}
#  # 7.1.262


- name: Delete Namespaces
  shell: |
    kubectl delete namespace {{ item }}
  register: delete_namespaces
  ignore_errors: true
  with_items:
    - korifi
  args:
    chdir: "{{ base_path }}/"
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.PATH }}"
- debug: msg={{ delete_namespaces }}
  when: print_debug == true
#  - reflector
#  - metrics-server


- name: Delete CF Namespace
  shell: |
    kubectl delete ns cf --grace-period=0 --force &
    sleep 10
  register: delete_cf_ns
  ignore_errors: true
  args:
    chdir: "{{ base_path }}/"
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.PATH }}"
- debug: msg={{ delete_cf_ns }}
  when: print_debug == true


- name: Force Delete CF Namespace
  shell: |
    kubectl get namespace "cf" -o json   | tr -d "\n" | sed "s/\"finalizers\": \[[^]]\+\]/\"finalizers\": []/" | \
    kubectl replace --raw /api/v1/namespaces/cf/finalize -f -
  register: force_delete_cf_ns
  ignore_errors: true
  args:
    chdir: "{{ base_path }}/"
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.PATH }}"
- debug: msg={{ force_delete_cf_ns }}
  when: print_debug == true


- name: Delete Namespaces Config
  file:
    path: "{{ base_path }}/{{ item }}"
    state: absent
  register: delete_namespaces_config
  ignore_errors: true
  with_items:
    - "korifi-ns.yaml"
- debug: msg={{ delete_namespaces_config }}
  when: print_debug == true

