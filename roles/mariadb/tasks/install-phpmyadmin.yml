---
- name: Create Namespace for Persistent Volumes
  shell: |
    kubectl create namespace {{ item }}
  register: create_namespace
  with_items:
    - phpmyadmin
  args:
    chdir: "{{ base_path }}/"
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.PATH }}"
- debug: msg={{ create_namespace }}
  when: print_debug == true


#- name: Copy phpMyAdmin Config Yaml
#  template:
#    src: "{{ item }}.j2"
#    dest: "{{ base_path }}/{{ item }}"
#  register: copy_phpmyadmin_config_yaml
#  with_items:
#    - "phpmyadmin-values.yaml"
#- debug: msg={{ copy_phpmyadmin_config_yaml }}


# helm install phpmyadmin bitnami/phpmyadmin -n phpmyadmin -f phpmyadmin-values.yaml
- name: Deploy phpMyaAmin
  shell:
    helm install phpmyadmin bitnami/phpmyadmin -n phpmyadmin
  register: deploy_phpmyadmin
  args:
    chdir: "{{ base_path }}/"
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.PATH }}"
- debug: msg={{ deploy_phpmyadmin }}
  when: print_debug == true


- name: Validate if phpmyadmin Containers are Running Normally
  shell: |
    kubectl -n phpmyadmin get pods | sed 1d | awk '{print $3}' | grep Running | wc -l
  register: check_phpmyadmin_container
  until: phpmyadmin.replica|int == check_phpmyadmin_container.stdout|int
  retries: 60
  delay: 10
  args:
    chdir: "{{ base_path }}/"
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.PATH }}"
- debug: msg={{ check_phpmyadmin_container }}
  when: print_debug == true

