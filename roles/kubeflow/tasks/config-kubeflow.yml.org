# v1.9.1
# 1
kustomize build common/cert-manager/cert-manager/base | kubectl apply -f -
# check cert-manager pod


# 2
kustomize build common/cert-manager/kubeflow-issuer/base | kubectl apply -f -
#

# Waiting for cert-manager to be ready
kubectl wait --for=condition=ready pod -l 'app in (cert-manager,webhook)' -- timeout=180s -n cert-manager


# Install Istio
# Installing Istio configured with external authorization..."
# 3
kustomize build common/istio-1-22/istio-crds/base | kubectl apply -f -
kustomize build common/istio-1-22/istio-namespace/base | kubectl apply -f -
kustomize build common/istio-1-22/istio-install/base | kubectl apply -f -

# Waiting for all Istio Pods to become ready...
kubectl wait --for=condition=Ready pods --all -n istio-system --timeout 300s
#
# istio-system     pod/istio-ingressgateway-6d7fd54c5f-6q2jj      0/1     ContainerCreating   0          8s
# istio-system     pod/istiod-84c9b699b9-4c5p2                    0/1     ContainerCreating   0          8s
# kubectl get po -n istio-system


# 4 Installing oauth2-proxy
kustomize build common/oauth2-proxy/overlays/m2m-dex-only | kubectl apply -f -
kubectl wait --for=condition=ready pod -l 'app.kubernetes.io/name=oauth2-proxy' -- timeout=180s -n oauth2-proxy


# kustomize build common/dex/overlays/istio | kubectl apply -f -
# 5
# Dex
# echo "Installing Dex..."
kustomize build common/dex/overlays/oauth2-proxy | kubectl apply -f -
kubectl wait --for=condition=ready pods --all --timeout=180s -n auth

# kustomize build common/dex/overlays/istio | kubectl apply -f -
# kustomize build common/oauth2-proxy/base | kubectl apply -f -

# 6
# Knative
# kustomize build common/knative/knative-serving/overlays/gateways | kubectl apply -f -
# kustomize build common/knative/istio-1-23/cluster-local-gateway/base | kubectl apply -f -
# kustomize build common/knative/knative-eventing/base | kubectl apply -f -

# Need Retry
kustomize build common/knative/knative-serving/overlays/gateways | kubectl apply -f -

kustomize build common/istio-1-22/cluster-local-gateway/base | kubectl apply -f -

kustomize build common/knative/knative-eventing/base | kubectl apply -f -




# 7
# Kubeflow Namespace
kustomize build common/kubeflow-namespace/base | kubectl apply -f -

# 8
# Network Policies
kustomize build common/networkpolicies/base | kubectl apply -f -

# 9
# Kubeflow Roles
kustomize build common/kubeflow-roles/base | kubectl apply -f -

# 10
# Kubeflow Istio Resources
kustomize build common/istio-1-23/kubeflow-istio-resources/base | kubectl apply -f -

# 11
# Kubeflow Pipelines
kustomize build apps/pipeline/upstream/env/cert-manager/platform-agnostic-multi-user | kubectl apply -f -
# kustomize build apps/pipeline/upstream/env/platform-agnostic-multi-user | kubectl apply -f -

# 12
# KServe
kustomize build contrib/kserve/kserve | kubectl apply -f -
kustomize build contrib/kserve/models-web-app/overlays/kubeflow | kubectl apply -f -

# 13
# Katib
kustomize build apps/katib/upstream/installs/katib-with-kubeflow | kubectl apply -f -

# 14
# Central Dashboard
kustomize build apps/centraldashboard/overlays/oauth2-proxy | kubectl apply -f -

# 15
# Admission Webhook
kustomize build apps/admission-webhook/upstream/overlays/cert-manager | kubectl apply -f -

# 16
# Notebooks 1.0
kustomize build apps/jupyter/notebook-controller/upstream/overlays/kubeflow | kubectl apply -f -
kustomize build apps/jupyter/jupyter-web-app/upstream/overlays/istio | kubectl apply -f -

# 17
# PVC Viewer Controller
kustomize build apps/pvcviewer-controller/upstream/default | kubectl apply -f -

# 18
# Profiles + KFAM
kustomize build apps/profiles/upstream/overlays/kubeflow | kubectl apply -f -

# 19
# Volumes Web Application
kustomize build apps/volumes-web-app/upstream/overlays/istio | kubectl apply -f -

# 20
# Tensorboard
kustomize build apps/tensorboard/tensorboards-web-app/upstream/overlays/istio | kubectl apply -f -
kustomize build apps/tensorboard/tensorboards-controller/upstream/overlays/kubeflow | kubectl apply -f -

# 21
# Training Operator
kustomize build apps/training-operator/upstream/overlays/kubeflow | kubectl apply -f -

# 22
# User Namespace
kustomize build common/user-namespace/base | kubectl apply -f -

