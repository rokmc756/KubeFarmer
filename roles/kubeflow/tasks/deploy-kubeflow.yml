---
- name: Create KubeFlow PVC
  import_tasks: create-kubeflow-pvc.yml


# while ! kustomize build example | kubectl apply -f -; do echo "Retrying to apply resources"; sleep 10; done
# find ./apps -name *mysql-deployment.yaml -exec sed '/mysql_native_password/d' {}\;
# find ./apps -name *registry-db-deployment.yaml -exec sed -i -e '/mysql_native_password/d' {} \;


- name: Deploy Kubeflow
  shell: |
    kustomize build {{ item }}
  register: deploy_kubeflow
  ignore_errors: true
  until: deploy_kubeflow is succeeded
  retries: 10
  delay: 10
  args:
    chdir: "{{ base_path }}/manifests"
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.PATH }}"
  with_items:
    - "common/cert-manager/cert-manager/base | kubectl apply -f -"                                   # 1
    - "common/cert-manager/kubeflow-issuer/base | kubectl apply -f -"                                # 2
    - "common/istio-1-22/istio-crds/base | kubectl apply -f -"                                       # 3
    - "common/istio-1-22/istio-namespace/base | kubectl apply -f -"                                  # 4
    - "common/istio-1-22/istio-install/overlays/oauth2-proxy | kubectl apply -f -"                   # 5
    - "common/oauth2-proxy/overlays/m2m-dex-only | kubectl apply -f -"                               # 6
    - "common/dex/overlays/oauth2-proxy | kubectl apply -f -"                                        # 7
    - "common/knative/knative-serving/overlays/gateways | kubectl apply -f -"                        # 8 Before failure
    - "common/istio-1-22/cluster-local-gateway/base | kubectl apply -f -"                            # 10
    - "common/knative/knative-eventing/base | kubectl apply -f -"                                    # 9 Failed
    - "common/kubeflow-namespace/base | kubectl apply -f -"                                          # 11
    - "common/networkpolicies/base | kubectl apply -f -"                                             # 12
    - "common/kubeflow-roles/base | kubectl apply -f -"                                              # 13
    - "common/istio-1-22/kubeflow-istio-resources/base | kubectl apply -f -"                         # 14
    - "apps/pipeline/upstream/env/cert-manager/platform-agnostic-multi-user | kubectl apply -f -"    # 15
    - "contrib/kserve/kserve | kubectl apply --server-side --force-conflicts -f -"                   # 16
    - "contrib/kserve/models-web-app/overlays/kubeflow | kubectl apply -f -"                         # 17
    - "apps/katib/upstream/installs/katib-with-kubeflow | kubectl apply -f -"                        # 18
    - "apps/centraldashboard/overlays/oauth2-proxy | kubectl apply -f -"                             # 19
    - "apps/admission-webhook/upstream/overlays/cert-manager | kubectl apply -f -"                   # 20
    - "apps/jupyter/notebook-controller/upstream/overlays/kubeflow | kubectl apply -f -"             # 21
    - "apps/jupyter/jupyter-web-app/upstream/overlays/istio | kubectl apply -f -"                    # 22
    - "apps/pvcviewer-controller/upstream/default | kubectl apply -f -"                              # 23
    - "apps/profiles/upstream/overlays/kubeflow | kubectl apply -f -"                                # 24
    - "apps/volumes-web-app/upstream/overlays/istio | kubectl apply -f -"                            # 25
    - "apps/tensorboard/tensorboards-web-app/upstream/overlays/istio | kubectl apply -f -"           # 26
    - "apps/tensorboard/tensorboard-controller/upstream/overlays/kubeflow | kubectl apply -f -"      # 27
    - "apps/training-operator/upstream/overlays/kubeflow | kubectl apply -f -"                       # 28
    - "common/user-namespace/base | kubectl apply -f -"                                              # 29
- debug: msg={{ deploy_kubeflow }}
  when: print_debug == true

# - "common/knative/knative-eventing/base | kubectl apply -f -"                                    # 9 Failed
# Error: map[string]interface {}(nil): yaml: unmarshal errors:
# line 116: mapping key "observedGeneration" already defined at line 85
# error: no objects passed to apply

# failed: [rk9-node01] (item=apps/katib/upstream/installs/katib-with-kubeflow | kubectl apply -f -
# "mutatingwebhookconfiguration.admissionregistration.k8s.io/katib.kubeflow.org configured"


# istio-1.23
#    - "common/cert-manager/base | kubectl apply -f -"                                                # 1
#    - "common/cert-manager/kubeflow-issuer/base | kubectl apply -f -"                                # 2
#    - "common/istio-1-23/istio-crds/base | kubectl apply -f -"                                       # 3
#    - "common/istio-1-23/istio-namespace/base | kubectl apply -f -"                                  # 4
#    - "common/istio-1-23/istio-install/base | kubectl apply -f -"                                    # 5
#    - "common/oauth2-proxy/overlays/m2m-dex-only | kubectl apply -f -"                               # 6
#    - "common/dex/overlays/oauth2-proxy | kubectl apply -f -"                                        # 7
#    - "common/knative/knative-serving/overlays/gateways | kubectl apply -f -"                        # 8 Before failure
#    - "common/istio-1-23/cluster-local-gateway/base | kubectl apply -f -"                            # 10
#    - "common/kubeflow-namespace/base | kubectl apply -f -"                                          # 11
#    - "common/networkpolicies/base | kubectl apply -f -"                                             # 12
#    - "common/kubeflow-roles/base | kubectl apply -f -"                                              # 13
#    - "common/istio-1-23/kubeflow-istio-resources/base | kubectl apply -f -"                         # 14
#    - "apps/pipeline/upstream/env/cert-manager/platform-agnostic-multi-user | kubectl apply -f -"    # 15
#    - "contrib/kserve/kserve | kubectl apply --server-side --force-conflicts -f -"                   # 16
#    - "contrib/kserve/models-web-app/overlays/kubeflow | kubectl apply -f -"                         # 17
#    - "apps/katib/upstream/installs/katib-with-kubeflow | kubectl apply -f -"                        # 18
#    - "apps/centraldashboard/overlays/oauth2-proxy | kubectl apply -f -"                             # 19
#    - "apps/admission-webhook/upstream/overlays/cert-manager | kubectl apply -f -"                   # 20
#    - "apps/jupyter/notebook-controller/upstream/overlays/kubeflow | kubectl apply -f -"             # 21
#    - "apps/jupyter/jupyter-web-app/upstream/overlays/istio | kubectl apply -f -"                    # 22
#    - "apps/pvcviewer-controller/upstream/default | kubectl apply -f -"                              # 23
#    - "apps/profiles/upstream/overlays/kubeflow | kubectl apply -f -"                                # 24
#    - "apps/volumes-web-app/upstream/overlays/istio | kubectl apply -f -"                            # 25
#    - "apps/tensorboard/tensorboards-web-app/upstream/overlays/istio | kubectl apply -f -"           # 26
#    - "apps/tensorboard/tensorboard-controller/upstream/overlays/kubeflow | kubectl apply -f -"      # 27
#    - "apps/training-operator/upstream/overlays/kubeflow | kubectl apply -f -"                       # 28
#    - "common/user-namespace/base | kubectl apply -f -"                                              # 29



# Dex Default User and Password
# id : user@example.com
# pwd : 12341234


# https://ohchangss.com/2023/10/19/kubeflow-rke2-metallb-load-balancer-%EC%84%A4%EC%A0%95-%EB%B0%8F-%ED%85%8C%EC%8A%A4%ED%8A%B8/
# https://korjwl1.tistory.com/34

# https://blog.ntnx.jp/entry/2024/03/09/121846


