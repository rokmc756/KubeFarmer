- name: Create Namespace for Rancher
  shell: |
    kubectl create namespace cattle-system
  register: create_rancher_namespace
- debug: msg={{ create_rancher_namespace }}


- name: Install Rancher by Helm
  shell: |
    helm install rancher rancher-stable/rancher --namespace cattle-system --set hostname={{ rancher.hostname }}
  register: install_rancher
- debug: msg={{ install_rancher }}


- name: Check the Status of the Deployment
  shell: |
    kubectl -n cattle-system rollout status deploy/rancher
  register: check_deployment_status
- debug: msg={{ check_deployment_status }}


- name: Check if Rancher is Deployed Successfully
  shell: kubectl get all -n cattle-system
  register: check_rancher_deployment
  ignore_errors: yes
  until: check_rancher_deployment.stdout.find("NotReady") == -1
  retries: 20
- debug: msg={{ check_rancher_deployment }}


- name: Get IP Address of Rancher Load Balancer and Nginx Ingress Controller
  shell: |
    kubectl get all -A | grep -E "service/rancher-loadbalancer|service/nginx-ingress-controller"
  register: get_ipaddr_rancher_lb
  ignore_errors: yes
- debug: msg={{ get_ipaddr_rancher_lb }}

# [ Check Rancher and NGINX Ingress ]
# kubectl get events --all-namespaces  --sort-by='.metadata.creationTimestamp'
# kubectl -n cattle-system describe pods
# kubectl -n cattle-system get all
# kubectl -n cattle-system get pods
# kubectl -n cattle-system logs <pod-name>
