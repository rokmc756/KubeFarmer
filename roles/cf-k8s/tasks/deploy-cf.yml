# https://www.devopsschool.com/blog/getting-started-with-cloud-foundry-for-kubernetes-using-cf-for-k8s-in-linuxubuntu/
# https://hub.docker.com/r/cloudfoundry/oratos-metrics-server-cf-for-k8s/tags

- name: Copy Metrics Server Config Yaml
  template:
    src: "{{ item }}.j2"
    dest: "{{ base_path }}/{{ item }}"
  register: copy_metrics_server_config_yaml
  with_items:
    - "metrics-server-values.yaml"
- debug: msg={{ copy_metrics_server_config_yaml }}


# --version 3.8.2
#- name: Deploy Metrics Server
#  shell: |
#    /usr/local/bin/helm install metrics-server metrics-server/metrics-server -n kube-system -f metrics-server-values.yaml
#  register: deploy_metrics_server
#  args:
#    chdir: "{{ base_path }}/"
#- debug: msg={{ deploy_metrics_server }}
#  when: print_debug == true
#
#- name: Validate if Metrics Server Container is Running
#  shell: |
#    kubectl -n kube-system get pod | grep metrics-server- | awk '{print $3}'
#  register: check_metrics_server_container
#  until: check_metrics_server_container.stdout.find("Running") != -1
#  retries: 100
#  delay: 10
#- debug: msg={{ check_metrics_server_container }}
#  when: print_debug == true


- name: Create Directory for Persistent Volumes
  file:
    path: "{{ cf_k8s.storage_path }}"
    state: directory
    owner: root
    group: root
    mode: 0777
  register: create_pv_dir
  delegate_to: "{{ item }}"
  delegate_facts: True
  with_items:
    - "{{ groups['all'] }}"
- debug: msg={{ create_pv_dir }}
  when: print_debug == true


- name: Create Namespace for Persistent Volumes
  shell: |
    kubectl create namespace {{ item }}
  register: create_namespace
  with_items:
    - cf-db
    - cf-blobstore
- debug: msg={{ create_namespace }}
  when: print_debug == true


- name: Copy Cluster Local PVC Config Yaml
  template:
    src: "{{ item }}.j2"
    dest: "{{ base_path }}/{{ item }}"
  register: copy_cluster_local_pvc_config_yaml
  with_items:
    - "local-storage-class.yaml"
    - "local-storage-pv.yaml"
    - "local-storage-pvc.yaml"
- debug: msg={{ copy_cluster_local_pvc_config_yaml }}


- name: Cluster Settings for a Production Cluster Running in a Dynamic Cloud Environment including VMware
  shell: |
    kubectl create -f {{ item }}
  register: create_pvc
  with_items:
    - "local-storage-class.yaml"
    - "local-storage-pv.yaml"
    - "local-storage-pvc.yaml"
  args:
    chdir: "{{ base_path }}/"
- debug: msg={{ create_pvc }}
  when: print_debug == true


- name: Check if CF-For-K8S is Already Downloaded
  stat: path={{ base_path }}/cf-for-k8s
  register: cf_k8s_dir
- debug: msg={{ cf_k8s_dir }}


# \
# --branch v{{ cf_k8s.major_version }}.{{ cf_k8s.minor_version }}.{{ cf_k8s.patch_version }}
- name: Clone CF-For-K8S
  shell: |
    git -C "{{ base_path }}" clone https://github.com/cloudfoundry/cf-for-k8s.git
  register: clone_cf_k8s
  ignore_errors: yes
  when: cf_k8s_dir.stat.exists == false
- debug: msg={{ clone_cf_k8s }}
  when: cf_k8s_dir.stat.exists == false


- name: Generate Yaml used to deploy CF for K8S
  shell: |
    ./hack/generate-values.sh -d vcap.me > ./cf-install-values.yml
  register: generate_cf_k8s_yaml
  args:
    chdir: "{{ base_path }}/cf-for-k8s/"
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.PATH }}"
- debug: msg={{ generate_cf_k8s_yaml }}


# To the bottom of the ./cf-install-values.yml replacing with your information. You can copy/paste or use the following command.
# docker login -u rokmc756@gmail.com -p Mc002661\!\@ https://index.docker.io/v1
- name: Append the app_registry credentials to your DockerHub registry
  lineinfile:
    path: "{{ base_path }}/cf-for-k8s/cf-install-values.yml"
    line: '{{item}}'
    state: present
  loop:
    - "app_registry:"
    - "  hostname: https://index.docker.io/v1/"
    - "  repository_prefix: \"cf-for-k8s-test\""
    - "  username: \"rokmc756@gmail.com\""
    - "  password: \"Mc002661!@\""
  register: append_cred_app_registry
- debug: msg={{ append_cred_app_registry }}


- name: Add a metrics server because kind does not come with one
  lineinfile:
    path: "{{ base_path }}/cf-for-k8s/cf-install-values.yml"
    line: "{{ item }}"
    state: present
  loop:
    - "add_metrics_server_components: true"
    - "enable_automount_service_account_token: true"
    - "metrics_server_prefer_internal_kubelet_address: true"
    - "remove_resource_requirements: true"
    - "use_first_party_jwt_tokens: true"
    - " "
    - " "
    - "load_balancer:"
    - "  enable: false"
  register: add_metrics_server
- debug: msg={{ add_metrics_server }}


- name: Render the final Kubernetes template to raw Kubernetes configuration
  shell: |
    ytt -f config -f ./cf-install-values.yml > ./cf-for-k8s-rendered.yml
  register: render_final_k8s_template
  args:
    chdir: "{{ base_path }}/cf-for-k8s"
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.PATH }}"
- debug: msg={{ render_final_k8s_template }}


- name: Replace Metrics Server Image Line
  lineinfile:
    path: "{{ base_path }}/cf-for-k8s/cf-for-k8s-rendered.yml"
    regexp: '^(.*)image: oratos/metrics-server:v(.*)$'
    line: "        image: cloudfoundry/oratos-metrics-server-cf-for-k8s:v0.3.6@sha256:a37da13de7b74c373e8698dee7836ce5fdbd102c3c1c8b9953a95e7f20138ab6"
    backrefs: yes
  register: replace_metrics_server_image_line
- debug: msg={{ replace_metrics_server_image_line }}


#  kapp list
- name: Deploy CF for K8S
  shell: |
    kapp deploy -a cf -f ./cf-for-k8s-rendered.yml -y
  register: deploy_cf_for_k8s
  args:
    chdir: "{{ base_path }}/cf-for-k8s"
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.PATH }}"
- debug: msg={{ deploy_cf_for_k8s }}


#TASK [cf-k8s : Deploy CF for K8S] *************************************************************************************************************************************************
#fatal: [rk9-node05]: FAILED! => {"changed": true, "cmd": "kapp deploy -a cf -f ./cf-for-k8s-rendered.yml -y\nkapp list\n", "delta": "0:00:00.044973", "end": "2024-06-28 15:05:42.793373", "msg": "non-zero return code", "rc": 1, "start": "2024-06-28 15:05:42.748400", "stderr": "kapp: Error: Building Kubernetes config: invalid configuration: no configuration has been provided, try setting KUBERNETES_MASTER environment variable (hint: Ensure cluster name is specified correctly in context configuration)\nkapp: Error: Building Kubernetes config: invalid configuration: no configuration has been provided, try setting KUBERNETES_MASTER environment variable (hint: Ensure cluster name is specified correctly in context configuration)", "stderr_lines": ["kapp: Error: Building Kubernetes config: invalid configuration: no configuration has been provided, try setting KUBERNETES_MASTER environment variable (hint: Ensure cluster name is specified correctly in context configuration)", "kapp: Error: Building Kubernetes config: invalid configuration: no configuration has been provided, try setting KUBERNETES_MASTER environment variable (hint: Ensure cluster name is specified correctly in context configuration)"], "stdout": "", "stdout_lines": []}

