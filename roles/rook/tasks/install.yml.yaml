# https://itmaya.co.kr/wboard/view.php?wb=tech&idx=35
# https://gcore.com/learning/deploying-highly-scalable-cloud-storage-with-rook-part-1-ceph-storage/
# Latest version 5/25, 2024
# https://www.digitalocean.com/community/tutorials/how-to-set-up-a-ceph-cluster-within-kubernetes-using-rook

# kubectl get csidrivers
#
# ? kubectl logs csi-cephfsplugin-bndd8 -c driver-registrar
#
# kubectl logs pod/csi-rbdplugin-4jbgn -n rook-ceph
# Defaulted container "driver-registrar" out of: driver-registrar, csi-rbdplugin
# I0525 05:14:51.649554   20679 main.go:135] Version: v2.10.1
# I0525 05:14:51.649626   20679 main.go:136] Running node-driver-registrar in mode=
# W0525 05:15:01.650765   20679 connection.go:234] Still connecting to unix:///csi/csi.sock
# W0525 05:15:11.650232   20679 connection.go:234] Still connecting to unix:///csi/csi.sock
# W0525 05:15:21.650566   20679 connection.go:234] Still connecting to unix:///csi/csi.sock
# E0525 05:15:21.650623   20679 main.go:160] error connecting to CSI driver: context deadline exceeded
#
# kubectl get csinodes


- name: Clone Rook
  shell: |
    git -C "{{ base_path }}" clone --single-branch --branch release-1.14 https://github.com/rook/rook.git
  register: clone_rook
  ignore_errors: true
- debug: msg={{ clone_rook }}


- name: X
  shell: |
    kubectl apply -f common.yaml
  register: X
  args:
    chdir: "{{ base_path }}/rook/deploy/examples/"
- debug: msg={{ X }}
  # kubectl apply -f kubernetes/ceph/common.yaml


- name: X
  shell: |
    kubectl apply -f operator.yaml
  register: X
  args:
    chdir: "{{ base_path }}/rook/deploy/examples/"
- debug: msg={{ X }}


- name: X
  shell: |
    kubectl apply -f crds.yaml
  register: X
  args:
    chdir: "{{ base_path }}/rook/deploy/examples/"
- debug: msg={{ X }}


- name: X
  shell: |
    kubectl apply -f cluster.yaml
  register: X
  args:
    chdir: "{{ base_path }}/rook/deploy/examples/"
- debug: msg={{ X }}


- name: X
  shell: |
    kubectl apply -f filesystem.yaml
  register: X
  args:
    chdir: "{{ base_path }}/rook/deploy/examples/"
- debug: msg={{ X }}


- name: X
  shell: |
    kubectl apply -f csi/cephfs/storageclass.yaml
  register: X
  args:
    chdir: "{{ base_path }}/rook/deploy/examples/"
- debug: msg={{ X }}
# rook/deploy/examples/csi/cephfs/storageclass.yaml
# rook/deploy/examples/csi/nfs/storageclass.yaml
# rook/deploy/examples/csi/rbd/storageclass.yaml

- name: X
  shell: |
    kubectl apply -f toolbox.yaml
  register: X
  args:
    chdir: "{{ base_path }}/rook/deploy/examples/"
- debug: msg={{ X }}

- name: X
  shell: |
    kubectl get deploy rook-ceph-tools -n rook-ceph
  register: X
- debug: msg={{ X }}

# $ kubectl -n rook-ceph exec -it $(kubectl -n rook-ceph get pod -l "app=rook-ceph-tools" -o jsonpath='{.items[0].metadata.name}') bash
# (toolbox)$ ceph -s
# (toolbox)$ ceph osd status
#

- name: Check if Rook is Deployed Successfully
  shell: kubectl get CephFileSystem -A
  register: check_rook_deployment
  ignore_errors: yes
  until: check_rook_deployment.stdout.find("Progressing") == -1
  retries: 20
- debug: msg={{ check_rook_deployment }}
# rook-ceph   myfs   1           28s   Progressing
# rook-ceph   myfs   1           60s   Ready


- name: X
  shell: |
    kubectl apply -f csi/cephfs/kube-registry.yaml
  register: X
  args:
    chdir: "{{ base_path }}/rook/deploy/examples/"
- debug: msg={{ X }}


- name: X
  shell: |
    kubectl apply -f dashboard-loadbalancer.yaml
  register: X
  args:
    chdir: "{{ base_path }}/rook/deploy/examples/"
- debug: msg={{ X }}


- name: Get IP Address of Rook Load Balancer and Nginx Ingress Controller
  shell: |
    kubectl get all -A | grep -E "service/rook-loadbalancer|service/nginx-ingress-controller"
  register: get_ipaddr_rook_lb
  ignore_errors: yes
- debug: msg={{ get_ipaddr_rook_lb }}


# [ Check Rook and NGINX Ingress ]
# kubectl get events --all-namespaces  --sort-by='.metadata.creationTimestamp'
# kubectl -n cattle-system describe pods
# kubectl -n cattle-system get all
# kubectl -n cattle-system get pods
# kubectl -n cattle-system logs <pod-name>

