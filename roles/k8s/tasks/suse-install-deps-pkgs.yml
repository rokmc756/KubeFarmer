---
# Install Kubernetes Software
#
- name: Install RPM Packages of Dependenies to Need Installing Packages Regarding Kubernates
  zypper:
    name: "{{ item }}"
    state: present
  ignore_errors: yes
  with_items: "{{ install_pkgs }}"

# zypper ar -f https://pkgs.k8s.io/core:/stable:/v1.27/rpm/ kubernetes
#- name: Add Docker Repository in All Nodes
#  yum_repository:
#    name: docker-ce
#    description: Add docker repsotiry
#    baseurl: "https://download.docker.com/linux/centos/{{ hostvars[inventory_hostname].ansible_distribution_major_version }}/x86_64/stable/"
#    gpgcheck: "no"
#  when: ( ansible_distribution == "RedHat" or ansible_distribution == "CentOS" or ansible_distribution == "Rocky" ) and ansible_distribution_major_version|int >= 9


- name: Add Kubernetes Repository
  shell: |
    zypper ar -f https://pkgs.k8s.io/core:/stable:/v{{ k8s.major_version }}.{{ k8s.minor_version }}/rpm/ kubernetes
    rpm --import https://pkgs.k8s.io/core:/stable:/v{{ k8s.major_version }}.{{ k8s.minor_version }}/rpm/repodata/repomd.xml.key
  register: k8s_repo_added

# zypper --releasever=15.5 dup --download-in-advance --allow-vendor-change -y
# zypper --releasever=15.5 lr -duE

# rpm --import https://pkgs.k8s.io/core:/stable:/v1.27/rpm/repodata/repomd.xml.key
- name: Install Docker Packages of the Latest Version in All Nodes
  package:
    name: "{{ item }}"
    state: present
  with_items: "{{ suse_docker_pkgs }}"
# zypper refresh
# zypper install kubelet kubeadm kubectl


- name: Copy expect script file to change admin password
  template: src=install-kube-pkgs.sh.j2 dest=/root/install-kube-pkgs.sh  mode=0755 owner=root group=root
  register: expect_file_copied


- name: Install Kubeadm Packages for All Nodes
  shell: /root/install-kube-pkgs.sh
  register: kube_pkgs_installed

#
#- name: Install Kubeadm Packages for All Nodes
#  zypper:
#    name: "{{ item }}"
#    state: present
#    extra_args: 
#  with_items:
#    - "kubeadm"
#    - "kubelet"
#    - "kubectl"
#    {{ k8s.major_version }}.{{ k8s.minor_version }}.{{ k8s.patch_version }}"


# zypper addlock kubelet kubeadm kubectl
# systemctl enable kubelet.service


#- name: Install Cgroup Packages in All Nodes
#  package:
#    name: "{{ item }}"
#    state: present
#  with_items:
#    - libcgroup
#    - libcgroup-tools
#  when: install_dep_packages and hostvars[inventory_hostname].ansible_distribution_major_version|int < 9

# https://stackoverflow.com/questions/62795930/how-to-install-kubernetes-in-suse-linux-enterprize-server-15-virtual-machines
# zypper -n install --force kubelet
# https://download.opensuse.org/repositories/Virtualization:/containers/15.6/
# zypper addrepo https://download.opensuse.org/repositories/Virtualization:/containers/15.6/Virtualization:containers.repo virt

