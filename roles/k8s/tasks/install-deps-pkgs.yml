---
# Install Kubernetes Cluster
#
- name: Install rpm packages of dependenies to need installing packages regarding kubernates for RHEL or Rocky 9
  package:
    name: "{{ item }}"
    state: present
  ignore_errors: yes
  with_items: "{{ install_pkgs }}"
  when: install_dep_packages and hostvars[inventory_hostname].ansible_distribution_major_version|int >= 9

#
- name: Install rpm packages of dependenies to need installing packages regarding kubernates for RHEL / CentOS 7
  package:
    name: "{{ item }}"
    state: present
  register: selinux_policy_installed
  with_items:
    - python2
    - python2-libselinux
  when: install_dep_packages and hostvars[inventory_hostname].ansible_distribution_major_version|int <= 8

#
- debug:
    var: selinux_policy_installed
  when: print_debug

#
- name: Add docker repository in all nodes
  yum_repository:
    name: docker-ce
    description: Add docker repsotiry
    baseurl: "https://download.docker.com/linux/centos/{{ hostvars[inventory_hostname].ansible_distribution_major_version }}/x86_64/stable/"
    gpgcheck: "no"
    # baseurl: "https://download.docker.com/linux/centos/docker-ce.repo"

#
- name: Install docker-ce packages of the latest version in all nodes
  package:
    name: "{{ item }}"
    state: present
  with_items: "{{ rh_docker_pkgs }}"
  when: install_dep_packages

#
- name: Add Kubernetes repositories in all nodes
  template: src=kubernetes.repo.j2 dest=/etc/yum.repos.d/kubernetes.repo owner=root group=root mode=644 force=yes
  register: kubernetes_repo_added

#
- name: Install kubeadm packages for all nodes
  package:
    name: "{{ item }}"
    state: present
  with_items:
    - "kubectl-{{ k8s_major_version }}.{{ k8s_minor_version }}.{{ k8s_patch_version }}"
    - "kubelet-{{ k8s_major_version }}.{{ k8s_minor_version }}.{{ k8s_patch_version }}"
    - "kubeadm-{{ k8s_major_version }}.{{ k8s_minor_version }}.{{ k8s_patch_version }}"
  when: install_k8s_packages

#
- name: Install Cgroup packages in all nodes
  package:
    name: "{{ item }}"
    state: present
  with_items:
    - libcgroup
    - libcgroup-tools
  when: install_dep_packages and hostvars[inventory_hostname].ansible_distribution_major_version|int < 9

