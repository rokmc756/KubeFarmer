---
# Install Kubernetes Software
#
- name: Install RPM Packages of Dependenies to Need Installing Packages Regarding Kubernates
  package:
    name: "{{ item }}"
    state: present
  ignore_errors: yes
  with_items: "{{ install_pkgs }}"
  when: install_dep_packages and hostvars[inventory_hostname].ansible_distribution_major_version|int >= 9

#
- name: Install RPM Packages of Dependenies to Need Installing Packages Regarding Kubernates
  package:
    name: "{{ item }}"
    state: present
  register: selinux_policy_installed
  with_items: "{{ rh8_common_devel_pkgs }}"
  when: install_dep_packages and hostvars[inventory_hostname].ansible_distribution_major_version|int <= 8

#
- debug:
    var: selinux_policy_installed
  when: print_debug

#
- name: Add Docker Repository in All Nodes
  yum_repository:
    name: docker-ce
    description: Add docker repsotiry
    baseurl: "https://download.docker.com/linux/centos/{{ hostvars[inventory_hostname].ansible_distribution_major_version }}/x86_64/stable/"
    gpgcheck: "no"

#
- name: Install Docker-CE Packages of the Latest Version in All Nodes
  package:
    name: "{{ item }}"
    state: present
  with_items: "{{ rh_docker_pkgs }}"
  when: install_dep_packages

#
- name: Add Kubernetes Repositories in All Nodes
  template: src=kubernetes.repo.j2 dest=/etc/yum.repos.d/kubernetes.repo owner=root group=root mode=644 force=yes
  register: kubernetes_repo_added

#
- name: Install Kubeadm Packages for All Nodes
  package:
    name: "{{ item }}"
    state: present
  with_items:
    - "kubectl-{{ k8s_major_version }}.{{ k8s_minor_version }}.{{ k8s_patch_version }}"
    - "kubelet-{{ k8s_major_version }}.{{ k8s_minor_version }}.{{ k8s_patch_version }}"
    - "kubeadm-{{ k8s_major_version }}.{{ k8s_minor_version }}.{{ k8s_patch_version }}"
  when: install_k8s_packages

#
- name: Install Cgroup Packages in All Nodes
  package:
    name: "{{ item }}"
    state: present
  with_items:
    - libcgroup
    - libcgroup-tools
  when: install_dep_packages and hostvars[inventory_hostname].ansible_distribution_major_version|int < 9

