---
- name: Check OS ( Kubernetes )
  fail: msg="Not a Red Hat or SuSE or Ubuntu based system!"
  when: ansible_os_family != 'RedHat' or  ansible_os_family != 'CentOS' or  ansible_os_family != 'Rocky' or ansible_os_family != 'Suse' or ansible_os_family != 'Ubuntu'


- name: Set Facts For Network and Packages Informations
  import_tasks: set-k8s-facts.yml
  tags: init,uninit,reinit,prepare,clean,enable,disable,install,uninstall,add,remove,upgrade,downgrade,deploy,destroy


- name: Disable Seicurity Features with SELinux and Firewalld
  import_tasks: security/disable-security.yml
  tags: disable, reinit, install
  when: ( sec is defined and sec == true ) or ( k8s_all is defined and k8s_all == true )


- name: Install Kubernetes Packages
  import_tasks: install-kube-pkgs.yml
  tags: install
  when: ( pkgs is defined and pkgs == true ) or ( k8s_all is defined and k8s_all == true )


- name: Configure Kubernetes Packages
  import_tasks: config-kube-pkgs.yml
  tags: install
  when: ( config is defined and config == true ) or ( k8s_all is defined and k8s_all == true )


- name: Initialize Native Kubernetes Cluster
  import_tasks: init-k8s.yml
  tags: init, install
  when: ( kube is defined and kube == true ) or ( k8s_all is defined and k8s_all == true )


- name: Add Additional Slave Master Nodes
  import_tasks: ext/add-masters.yml
  tags: install, add
  when: ( master is defined and master == true )


- name: Add Additional Worker Nodes
  import_tasks: ext/add-workers.yml
  tags: install, add
  when: ( worker is defined and worker == true )


- name: Install Metallb
  import_tasks: install-metallb.yml
  tags: install
  when: (( lb is defined and lb == true ) or ( k8s_all is defined and k8s_all == true )) and inventory_hostname in groups['master']


- name: Uninstall Metallb
  import_tasks: uninstall-metallb.yml
  tags: uninstall
  when: (( lb is defined and lb == true ) or ( k8s_all is defined and k8s_all == true )) and inventory_hostname in groups['master']


- name: Remove Additional Worker Nodes
  import_tasks: ext/remove-workers.yml
  tags: uninstall, remove
  when: ( worker is defined and worker == true )


- name: Remove Additional Slave Master Nodes
  import_tasks: ext/remove-masters.yml
  tags: uninstall, remove
  when: ( master is defined and master == true )


- name: Reinitialize Kubernetes Cluster
  import_tasks: reinit-k8s.yml
  tags: reinit
  when: ( kube is defined and kube == true ) or ( k8s_all is defined and k8s_all == true )


- name: Stop Docker and Kube Services
  import_tasks: stop-kube-services.yml
  tags: uninstall
  when: ( kube is defined and kube == true ) or ( k8s_all is defined and k8s_all == true )


- name: Uninstall Prerequistes Packages
  import_tasks: uninstall-kube-pkgs.yml
  tags: uninstall
  when: ( pkgs is defined and pkgs == true ) or ( k8s_all is defined and k8s_all == true )


- name: Delete Kube Config Files
  import_tasks: uninstall-configs.yml
  tags: uninstall
  when: ( config is defined and config == true ) or ( k8s_all is defined and k8s_all == true )


- name: Reboot All Systems
  import_tasks: reboot-required.yml
  tags: uninstall, clean
  when: ( reboot is defined and reboot == true ) or ( k8s_all is defined and k8s_all == true )

